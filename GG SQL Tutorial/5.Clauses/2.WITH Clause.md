Consultas SQL podem ser **complexas**, especialmente quando envolvem **subconsultas aninhadas**, **agregaÃ§Ãµes** e **joins**.

Ã‰ nesse cenÃ¡rio que entra a clÃ¡usula **SQL WITH**, tambÃ©m conhecida como **Common Table Expressions (CTEs)**, para **simplificar** o processo.

A clÃ¡usula **WITH** Ã© uma ferramenta **poderosa** que: 
âœ… Torna consultas **mais legÃ­veis**. 
âœ… **Melhora o desempenho** ao definir **resultados temporÃ¡rios reutilizÃ¡veis**. 
âœ… **Evita repetiÃ§Ã£o de lÃ³gica**, organizando melhor o cÃ³digo SQL.

Seja para **agregar dados**, **analisar grandes volumes de informaÃ§Ã£o** ou **criar relatÃ³rios complexos**, entender como usar a clÃ¡usula **WITH** pode **melhorar significativamente sua experiÃªncia com SQL**.

Vamos explorar o bÃ¡sico e entender como essa ferramenta pode **simplificar suas consultas**!

### **O que Ã© a clÃ¡usula SQL WITH?**

A clÃ¡usula **WITH** no SQL Ã© usada para **definir tabelas temporÃ¡rias** ou **resultados intermediÃ¡rios** dentro de uma consulta.

Essas tabelas temporÃ¡rias, chamadas de **Common Table Expressions (CTEs)**, funcionam como **tabelas virtuais** que **existem apenas durante a execuÃ§Ã£o da consulta**.

ğŸ“Œ Podemos **referenciÃ¡-las vÃ¡rias vezes** na consulta principal, evitando **subconsultas repetitivas** e **melhorando a organizaÃ§Ã£o**.

### **Por que usar a clÃ¡usula WITH?**

âœ… **Melhora a legibilidade:** Divide consultas complexas em partes menores e mais organizadas. 
âœ… **Facilita a manutenÃ§Ã£o:** Torna mais simples **modificar e depurar** consultas SQL. 
âœ… **Otimiza o desempenho:** **Evita redundÃ¢ncia**, garantindo que resultados temporÃ¡rios sejam **calculados apenas uma vez**.

### **Sintaxe**

```
WITH tabelaTemporaria (valorMÃ©dio) AS (
    SELECT AVG (Atributo1)
    FROM Tabela
)
    SELECT Atributo1
    FROM Tabela, tabelaTemporaria
    WHERE Tabela.Atributo1 > tabelaTemporaria.valorMÃ©dio;
```

## **ExplicaÃ§Ã£o dos Termos**

ğŸ“Œ **WITH**: Define uma **tabela temporÃ¡ria** (`tabelaTemporaria`). 
ğŸ“Œ **AS (...):** ContÃ©m uma subconsulta que **gera os dados** para a tabela temporÃ¡ria. 
ğŸ“Œ **SELECT principal:** Usa a **tabela temporÃ¡ria** na consulta para **filtrar ou agrupar dados** com mais eficiÃªncia.

### **Importante: Como o SQL executa uma consulta com WITH?**

ğŸ“Œ **Passo 1:** A subconsulta dentro do **WITH** Ã© avaliada **primeiro**, gerando **a tabela temporÃ¡ria**. 
ğŸ“Œ **Passo 2:** A consulta principal **usa os dados da tabela temporÃ¡ria** para processar os resultados.

Isso **reduz a repetiÃ§Ã£o de cÃ¡lculos** e **melhora o desempenho** da consulta.

### **Exemplos PrÃ¡ticos da clÃ¡usula SQL WITH**

Vamos ver na prÃ¡tica **como a clÃ¡usula WITH pode simplificar consultas complexas**!

### **Exemplo 1: Encontrando FuncionÃ¡rios com SalÃ¡rio Acima da MÃ©dia**

ğŸ¯ **Objetivo:**
- **Calcular o salÃ¡rio mÃ©dio de todos os funcionÃ¡rios**.
- **Encontrar os funcionÃ¡rios que recebem acima da mÃ©dia**.

#### **Tabela Employee**

|EmployeeID|Nome|SalÃ¡rio|
|---|---|---|
|100011|Smith|50000|
|100022|Bill|94000|
|100027|Sam|70550|
|100845|Walden|80000|
|115585|Erik|60000|
|1100070|Kate|69000|

#### **Consulta com WITH**

```
WITH tabelaTemporaria (valorMedio) AS (
    SELECT AVG(SalÃ¡rio)
    FROM Employee
)
    SELECT EmployeeID, Nome, SalÃ¡rio 
    FROM Employee, tabelaTemporaria 
    WHERE Employee.SalÃ¡rio > tabelaTemporaria.valorMedio;
```

##### **SaÃ­da**

|EmployeeID|Nome|SalÃ¡rio|
|---|---|---|
|100022|Bill|94000|
|100845|Walden|80000|

ğŸ“Œ **ExplicaÃ§Ã£o**
- Primeiro, calculamos **o salÃ¡rio mÃ©dio** de todos os funcionÃ¡rios.
- Depois, **comparamos o salÃ¡rio** de cada funcionÃ¡rio com esse valor mÃ©dio.
- Retornamos **os funcionÃ¡rios que ganham acima da mÃ©dia**!

### **Exemplo 2: Encontrando Companhias AÃ©reas com Alto SalÃ¡rio de Pilotos**

ğŸ¯ **Objetivo:**
- **Calcular o salÃ¡rio total** de todos os pilotos de cada companhia aÃ©rea.
- **Comparar esse valor com o salÃ¡rio mÃ©dio dos pilotos**.

#### **Tabela Piloto**

|EmployeeID|Companhia AÃ©rea|Nome|SalÃ¡rio|
|---|---|---|---|
|70007|Airbus 380|Kim|60000|
|70002|Boeing|Laura|20000|
|10027|Airbus 380|Will|80050|
|10778|Airbus 380|Warren|80780|
|115585|Boeing|Smith|25000|
|114070|Airbus 380|Katy|78000|

#### **Consulta com WITH**

```
WITH totalSalario (Companhia, total) AS (
    SELECT CompanhiaAÃ©rea, SUM(SalÃ¡rio)
    FROM Piloto
    GROUP BY CompanhiaAÃ©rea
),
    mediaSalario (salarioMedio) AS (
    SELECT AVG(SalÃ¡rio)
    FROM Piloto 
)
    SELECT Companhia
    FROM totalSalario, mediaSalario
    WHERE totalSalario.total > mediaSalario.salarioMedio;
```

##### **SaÃ­da**

|Companhia AÃ©rea|
|---|
|Airbus 380|

ğŸ“Œ **ExplicaÃ§Ã£o**
- Calculamos **o salÃ¡rio total** dos pilotos **por companhia aÃ©rea**.
- Calculamos **o salÃ¡rio mÃ©dio geral dos pilotos**.
- **Filtramos as companhias aÃ©reas cujo salÃ¡rio total excede a mÃ©dia**.

## **Principais BenefÃ­cios da ClÃ¡usula WITH**

âœ… **Melhora a legibilidade**: Divide consultas complexas em partes menores e organizadas. 
âœ… **Evita repetiÃ§Ã£o de cÃ³digo**: Permite reutilizar subconsultas, **tornando o SQL mais eficiente**. 
âœ… **Otimiza desempenho**: SQL pode armazenar **resultados intermediÃ¡rios**, reduzindo cÃ¡lculos repetitivos. 
âœ… **Facilita a depuraÃ§Ã£o**: Como cada CTE (`WITH`) Ã© **definida separadamente**, fica mais fÃ¡cil **testar partes da consulta**.

### **Fatos Importantes sobre SQL WITH**

ğŸ“Œ **1. Tabelas temporÃ¡rias desaparecem apÃ³s a execuÃ§Ã£o** 
ğŸ“Œ **2. Podemos aninhar mÃºltiplos CTEs no mesmo WITH**

```
WITH CTE1 AS (...), CTE2 AS (...)
SELECT * FROM CTE1, CTE2;
```

ğŸ“Œ **3. Cuidado com grandes volumes de dados** Caso a tabela temporÃ¡ria contenha **muitos registros**, pode **afetar o desempenho**. 
âœ… Sempre verifique o **Plano de ExecuÃ§Ã£o** para garantir **eficiÃªncia**!

## **ConclusÃ£o**

ğŸ“Œ **A clÃ¡usula SQL WITH (Common Table Expressions - CTEs) Ã© essencial para simplificar consultas complexas**.

âœ… **Divide consultas grandes** em partes menores e legÃ­veis. 
âœ… **Melhora desempenho** ao evitar cÃ¡lculos repetitivos. 
âœ… **Facilita manutenÃ§Ã£o e depuraÃ§Ã£o**, tornando o cÃ³digo **mais limpo e organizado**.

ğŸš€ **Dominar essa ferramenta tornarÃ¡ suas consultas SQL muito mais poderosas!**



